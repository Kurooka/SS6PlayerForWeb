<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv=”Pragma” content=”no-cache”>
  <meta http-equiv=”Cache-Control” content=”no-cache”>
  <title>SpriteStudio6 Web Player</title>
  <!-- pixi.jsの読込 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.8.5/pixi.min.js"></script>
  <!-- flatbuffers関連 -->
  <script src="https://cdn.jsdelivr.net/npm/flatbuffers@1.10.2/js/flatbuffers.js"></script>
  <!-- ssfblib -->
  <script src="./ssfblib.umd.js"></script>
  <!-- ss6player -->
  <script src="../../packages/ss6player-pixi/dist/ss6player-pixi.umd.js"></script>
  <script src="./ss6player-controller.js"></script>

  <link rel="stylesheet" href="./rich-index.css">

</head>
<body>


  <script>
    let playerController = null;

    let pixiApplication = null;
    let ss6Project = null;
    let ss6Player = null;
    const ssfbFilePath = "./MeshBone/Knight.ssbp.ssfb";
    const previewWidth = 500;
    const previewHeight = 500;

    let playerElement;
    let previewElement;
    let animationPackAreaElement;
    let animationAreaElement;

    let playControlAreaElement;
    let playSwitchButtonElement;
    let frameNumberElement;
    let endFrameNumberElement;
    let seekBarElement;
    let fpsElement;



      
    function refreshPlaySwitch() {
      const isPlaying = playerController.ss6Player.isPlaying;
      const isPausing = playerController.ss6Player.isPausing;

      if(isPlaying){
        if(isPausing){
          playSwitchButtonElement.classList.remove('paused');

        }else{
          playSwitchButtonElement.classList.add('paused');

        }
        
      }else{
        playSwitchButtonElement.classList.remove('paused');

      }

    }


    window.onload = function(){
      // const ssaeName = 'Knight_bomb';
      // const animeName = 'Balloon';

      playerElement = document.querySelector('.player');
      previewElement = playerElement.querySelector('.preview');
      animationPackAreaElement = playerElement.querySelector('.animation-pack-area');
      animationAreaElement = playerElement.querySelector('.animation-area');

      playControlAreaElement = playerElement.querySelector('.play-control-area');
      playSwitchButtonElement = playerElement.querySelector('.play-switch-area .button-area');
      frameNumberElement = playControlAreaElement.querySelector('.frame-number');
      endFrameNumberElement = playControlAreaElement.querySelector('.end-frame-number');
      seekBarElement = playControlAreaElement.querySelector('.seek-bar');
      fpsElement = playerElement.querySelector('.fps');



      playerController = new SS6PlayerController(ssfbFilePath);
      playerController.onComplete = () => {
        const animePackMap = playerController.animePackMap;
        for(let animePackName in animePackMap){
          const element = document.createElement('button');
          element.innerText = animePackName;
          element.classList.add('animation-pack');
          element.addEventListener('click', (event) => {
            const element = event.currentTarget;
            const animePackName = element.innerText;

            const animePackMap = playerController.animePackMap;
            console.log(animePackMap);
            const animationMap = animePackMap[animePackName];
            console.log(animationMap);

            animationAreaElement.innerHTML = '';
            for(let animationName in animationMap){
              const element = document.createElement('button');
              element.innerText = animationName;
              element.classList.add('animation');
              element.setAttribute('data-animation-pack-name', animePackName);
              element.addEventListener('click', (event) => {
                const element = event.currentTarget;
                const animationName = element.innerText;

                const ssaeName = element.getAttribute('data-animation-pack-name');
                playerController.setupAnimation(ssaeName, animationName);
              });

              animationAreaElement.appendChild(element);
            }

            

          });
          animationPackAreaElement.appendChild(element);

        }

        

      };
      playerController.onUpdate = (player) => {
        frameNumberElement.innerText = player.currentCachedFrameNumber;
        seekBarElement.value = player.currentCachedFrameNumber;

      };
      playerController.onPlayStateChangeCallback = (isPlaying, isPausing) => {
        console.log('onPlayStateChangeCallback');
        if(isPlaying){
          seekBarElement.min = playerController.ss6Player.startFrame;
          seekBarElement.max = playerController.ss6Player.endFrame;
          endFrameNumberElement.innerText = playerController.ss6Player.endFrame;
          fpsElement.innerText = playerController.ss6Player.fps;

        }else{

        }

        refreshPlaySwitch();

      };
      playerController.load(previewElement);

      // 再生ボタン
      playSwitchButtonElement.addEventListener('click', (event) => {
        if(playerController.ss6Player.isPausing){
          playerController.ss6Player.Resume();
        }else if(playerController.ss6Player.isPlaying) {
          playerController.ss6Player.Pause();
        }else{
          playerController.ss6Player.Play();
        }
      });
      

      
      // アニメーションスピード
      const animationSpeedSelectElement = playerElement.querySelector('.animation-speed');
      animationSpeedSelectElement.addEventListener('change', (event)=>{
        const selectElement = event.currentTarget;
        const value = selectElement.value;
        playerController.ss6Player.SetAnimationSpeed(value);
      });

      // SeekBar変更
      seekBarElement.addEventListener('input', (event)=> {
        const rangeElement = event.currentTarget;
        const value = rangeElement.value;
        playerController.ss6Player.Pause();

        frameNumberElement.innerText = value;
        playerController.ss6Player._currentFrame = value;
        playerController.ss6Player.SetFrameAnimation(value);
      }, false);

      previewElement.addEventListener('mousedown', (event) => {
        // console.log('mousedown');
      });
      previewElement.addEventListener('mousemove', (event)=>{
        if(event.buttons === 1){
          // 左クリック時のみ
          const targetElement = event.target;
          if (event.target.tagName === 'CANVAS') {
            // キャンバス自体をドラッグ時のみ
            const movementX = event.movementX;
            const movementY = event.movementY;
            // console.log('movementX', movementX);
            // console.log('movementY', movementY);

            playerController.movePosition(movementX, movementY);

          }


        }
      })

    };

  </script>


  <div class="player">
    <div class="animation-pack-area">

    </div>
    <div class="animation-area">

    </div>

    <div class="preview">
      <div class="head-bar-area">
        <label>再生速度</label>
        <select class="animation-speed">
          <option value=0.5>x0.5</option>
          <option value=1 selected>x1</option>
          <option value=2>x2</option>
          <option value=3>x3</option>
        </select>
        <label>FPS</label><span class="fps"></span>

      </div>
      <div class="play-switch-area">
        <div class="button-area">
          <div class="play-switch-sign"></div>
        </div>
      </div>


      <div class="play-control-area">
        <div class="contents">
          
          <input type="range" class="seek-bar" value="0">
          <div class="frame-area">
            <span class="frame-number"></span>
            /
            <span class="end-frame-number"></span>

          </div>

        </div>
      
      
      </div>

    </div>
  </div>

</body>
</html>
